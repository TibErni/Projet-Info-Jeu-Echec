#include <stdio.h>
#include <stdbool.h>
#include <stdlib.h>

#define BOARD_SIZE 8

typedef enum {
    EMPTY,
    PLAYER1,
    PLAYER2
} Piece;

typedef Piece Board[BOARD_SIZE][BOARD_SIZE];

typedef enum {
    RED, GREEN, YELLOW, BLUE,
    MAGENTA, CYAN, WHITE, ORANGE
} Color;

void initialize_board(Board board) {
    for (int i = 0; i < BOARD_SIZE; i++) {
        for (int j = 0; j < BOARD_SIZE; j++) {
            if (i == 0) {
                board[i][j] = PLAYER1;
            } else if (i == BOARD_SIZE - 1) {
                board[i][j] = PLAYER2;
            } else {
                board[i][j] = EMPTY;
            }
        }
    }
}

void print_board(const Board board) {
    const char* colors[] = {
        "\033[31m", "\033[32m", "\033[33m", "\033[34m",
        "\033[35m", "\033[36m", "\033[37m", "\033[38;5;208m"
    };

    for (int i = 0; i < BOARD_SIZE; i++) {
        for (int j = 0; j < BOARD_SIZE; j++) {
            int color_index = (i * BOARD_SIZE + j) % 8;
            printf("%s", colors[color_index]);

            switch (board[i][j]) {
                case EMPTY:
                    printf(" ■ ");
                    break;
                case PLAYER1:
                    printf(" ▼ ");
                    break;
                case PLAYER2:
                    printf(" ▲ ");
                    break;
            }

            printf("\033[0m"); // Reset de l'attribut de couleur
        }
        printf("\n");
    }
}

bool is_inside_board(int x, int y) {
    return x >= 0 && x < BOARD_SIZE && y >= 0 && y < BOARD_SIZE;
}

bool is_piece_on_path(const Board board, int x_start, int y_start, int x_end, int y_end) {
    int dx = x_end - x_start;
    int dy = y_end - y_start;
    int x_step = (dx != 0) ? (dx > 0 ? 1 : -1) : 0;
    int y_step = (dy != 0) ? (dy > 0 ? 1 : -1) : 0;
    int x, y;

    for (x = x_start + x_step, y = y_start + y_step; x != x_end || y != y_end; x += x_step, y += y_step) {
        if (board[x][y] != EMPTY) {
            return true;
        }
    }

    return false;
}

bool is_valid_move(const Board board, Piece current_player, int x_start, int y_start, int x_end, int y_end, Color last_landed_color) {
    int dx = x_end - x_start;
    int dy = y_end - y_start;
    int target_color = (x_start * BOARD_SIZE + y_start) % 8;

    if (!is_inside_board(x_end, y_end)) {
        return false;
    }

    if (board[x_start][y_start] != current_player || board[x_end][y_end] != EMPTY) {
        return false;
    }

    if (last_landed_color != target_color) {
        return false;
    }

    if (current_player == PLAYER1) {
        if (!((dx > 0 && abs(dy) == dx) || (dx >= 1 && dy == 0) || (dx == 0 && abs(dy) >= 1))) {
            return false;
        }
    } else if (current_player == PLAYER2) {
        if (!((dx < 0 && abs(dy) == -dx) || (dx <= -1 && dy == 0) || (dx == 0 && abs(dy) >= 1))) {
            return false;
        }
    }

    if (is_piece_on_path(board, x_start, y_start, x_end, y_end)) {
        return false;
    }

    return true;
}

bool move_piece(Board board, Piece current_player, int x_start, int y_start, int x_end, int y_end, Color *last_landed_color) {
    if (is_valid_move(board, current_player, x_start, y_start, x_end, y_end, *last_landed_color)) {
        board[x_start][y_start] = EMPTY;
        board[x_end][y_end] = current_player;
        *last_landed_color = (x_end * BOARD_SIZE + y_end) % 8;
        return true;
    }
    return false;
}

int main() {
    Board board;
    initialize_board(board);

    printf("Plateau de jeu initial:\n");
    print_board(board);

    Piece current_player = PLAYER1;
    Color last_landed_color = RED;

    int x_start, y_start, x_end, y_end;
    while (true) {
        printf("Joueur %d, entrez les coordonnées de départ et d'arrivée (x_start y_start x_end y_end) ou -1 pour quitter: ", current_player);
        scanf("%d", &x_start);

        if (x_start == -1) {
            break;
        }

        scanf("%d %d %d", &y_start, &x_end, &y_end);

        if (move_piece(board, current_player, x_start, y_start, x_end, y_end, &last_landed_color)) {
            printf("Mouvement effectué.\n");
            print_board(board);
            current_player = (current_player == PLAYER1) ? PLAYER2 : PLAYER1;
        } else {
            printf("Mouvement invalide. Réessayez.\n");
        }
    }

    return 0;
}
